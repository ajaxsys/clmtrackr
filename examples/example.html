<!doctype html>
<html lang="en">

<head>
    <title>Face tracker</title>
    <meta charset="utf-8">
    <style>
        #container {
            position: relative;
        }

        #canvas {
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>

<body>
    <script src="./js/libs/jquery.min.js"></script>
    <script src="./js/libs/utils.js"></script>
    <script src="./js/libs/lodash.min.js"></script>
    <script src="../build/clmtrackr.js"></script>
    <div id="content">
        <h2>Example</h2>
        <div id="container">
            <video id="video"
                   width="368"
                   height="288"
                   autoplay
                   loop
                   playsinline>
                <source src="./media/franck.mp4"
                        type="video/mp4" />
                <source src="./media/franck.webm"
                        type="video/webm" />
            </video>
            <canvas id="canvas"
                    width="368"
                    height="288"></canvas>
            変動：<img id='croppedImage' />
            固定：<img id='resizedImage' />
        </div>
        <p>Printing coordinates of the first 10 points in facial features:</p>
        <p id="positions"></p>
        <script>
            const videoInput = document.getElementById('video');
            const canvasInput = document.getElementById('canvas');
            const out = document.getElementById('out')

            const ctx = canvasInput.getContext('2d');

            const ctracker = new clm.tracker();
            ctracker.init();
            ctracker.start(videoInput);

            let posX = 0;
            let posY = 0;
            let width = 0;
            let height = 0;

            const croppedImageTag = document.getElementById('croppedImage');
            let croppedImage = '';

            const resizedImageTag = document.getElementById('resizedImage');
            let resizedImage = '';

            function positionLoop() {
                requestAnimFrame(positionLoop);
                const positions = ctracker.getCurrentPosition();
                // do something with the positions ...
                // print the positions
                let positionString = "";
                if (positions) {
                    const posX_original = _.minBy(positions, p => p[0])[0];
                    const posY_original = _.minBy(positions, p => p[1])[1];
                    const maxLeft = _.maxBy(positions, p => p[0])[0];
                    const maxHeight = _.maxBy(positions, p => p[1])[1];
                    const width_original = maxLeft - posX_original;
                    const height_original = maxHeight - posY_original;
                    // document.getElementById('positions').innerHTML = `x=${posX_original}, y=${posY_original}, width=${width_original}, height=${height_original}`;

                    // Ajust to get more Ears
                    // if (height_original > width_original) {
                    //     const xPercent = 0.1, yPercent = 0.6;
                    //     const moreLefter = posX_original - width_original * xPercent;
                    //     posX = moreLefter > 0 ? moreLefter : 0;
                    //     const moreHeigter = posY_original - height_original * yPercent;
                    //     posY = moreHeigter > 0 ? moreHeigter : 0;
                    //     width = width_original * (1 + xPercent * 2);
                    //     height = height_original * (1 + yPercent);
                    // }

                    // Ajust to rect
                    if (height_original > width_original) {
                        const yPercent = 0.6;
                        let newHeight = height_original * (1 + yPercent); // 増高
                        newHeight = newHeight > canvasInput.height ? canvasInput.height : newHeight; // MAX高に超えないよう
                        const moreHeigterY = posY_original - (newHeight - height_original); // Yも増高
                        posY = moreHeigterY > 0 ? moreHeigterY : 0;// Yを枠に超えないよう
                        height = newHeight;

                        posX = posX_original - (height - width_original) / 2
                        width = height;
                    }
                }
            }
            positionLoop();

            function drawLoop() {
                requestAnimFrame(drawLoop);
                ctx.clearRect(0, 0, canvasInput.width, canvasInput.height);
                ctracker.draw(canvasInput);
                // Draw my rect
                ctx.strokeStyle = "red";
                ctx.strokeRect(posX, posY, width, height);

                // Draw icons
                const imageObj = new Image();
                // 32 px png icon
                imageObj.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAOw4AADsOAcy2oYMAAAAHdElNRQfjBRcGGSz0f5qTAAACFklEQVRIx63VzUtUYRQG8J93RlCQGDFHw/BjqwjOTsMWQYpIuAwx3Od/VLqWsnAjiShBShCIC0VcqSDiZJpCQyguDG2hjvc6d/zIzu4873nOe99zz3NOiXhLqtHksUr8krVh15+4wJIYLO25F9qknDhGqUDOkk8++3lTgpR+rz2y5Isl3x2gQp02z7T54a13copaxpQ9I9qVFZyVaTdiz5RMMXqvdQu6JItekNRtwbreeHrWuHo3Wb1x2cIUGavGVd9Ih2rjVqMPSZk0r+FWdGgwb1LqEhiyq/vWdOi2a+jCqbFoJF+6QFpaUECJ4kkjFtWcOQN2dOQDB61YMViQ4CreYccAJIyaVn4Opy07dWpZOkIvxMtNG5UI1MqYdXSnCsCRWRm1dNrWc82nFsd7bOukX1Zr0WJdh7fK6k9KOXYQgk8KFVcEP3AsFbinBXJKVYSQpCpBkdiqiNAqlMoFsgJ1IbjZRy2xCVp81Bzy6wSygQ25iDAONemKTdClyWHIz8jZuNpIJAxb1lhAb7RsWCLvnzcSV1uZVmvGLvr83GqMWYv87nwrXxUT9Nkyp1elhIRKveZs6YuUOiSmODl3mrFv0YQJi/bN6Iyc5+V8NpVTRj300mYo5IEnnmrApq+++R06a/DBvlfh+VxspJXEbI6Ykca9h+pZinULuv91rJ895M6L5a6r7Y330dX235fr5Wtvud7/AlAXs42d19StAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTA1LTIzVDA2OjI1OjQ0LTA0OjAwIPJHewAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wNS0yM1QwNjoyNTo0NC0wNDowMFGv/8cAAAAASUVORK5CYII='
                ctx.drawImage(imageObj, posX + width - 32, posY)

                // const trackerImgData = ctx.getImageData(posX, posY, maxLeft - posX, maxHeight - posY)

                // setTimeout VS requestAnimFrame: https://liginc.co.jp/web/js/130758
                // setTimeout(
                //     () => {
                //         // draw green line to image TODO
                //         // crop_img(ctx, trackerImgData);
                //         crop_video();
                //     },
                //     50);
                requestAnimFrame(crop_video)
            }
            drawLoop();

            // TODO use socket
            function ajaxSendServerLoop_ajax() {
                // try max fps / success then do next
                const url = '/api/emotion-detect'
                const data = resizedImage;
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: data,
                    success: (res) => {
                        console.log('Data should means smile or cry', res)
                    },
                    complete: () => {
                        ajaxSendServerLoop(); // Recursive
                    },
                    dataType: 'json'
                });
            }
            function ajaxSendServerLoop() {
                setInterval(() => {
                    console.log('Size of crop_video:', croppedImage.length, croppedImage);
                    console.log('Size of resize_image:', resizedImage.length, resizedImage)
                    console.log('===============')
                }, 50); // 1000 / 20 fps = 50 ms
            }
            ajaxSendServerLoop();

            function crop_img(ctx, trackerImgData) {}
            function crop_video() {
                // 画像切り取り
                var canvasTmp = document.createElement("canvas");
                canvasTmp.width = width;
                canvasTmp.height = height;
                var ctxTmp = canvasTmp.getContext("2d");
                ctxTmp.rect(0, 0,  width, height);
                // ctxTmp.fillStyle = 'white';
                // ctxTmp.fill();
                // ctxTmp.putImageData(crop.binarizer.source, 0, 0);
                ctxTmp.drawImage(videoInput,
                    posX, posY, width, height,
                    0, 0, width, height)
                // ctxTmp.putImageData(
                //     trackerImgData,
                //     0, 0);

                // ctxTmp.putImageData(
                //     trackerImgData,
                //     0, 0);

                if (width > height) {
                    croppedImageTag.setAttribute('width', width + 'px');
                    croppedImageTag.setAttribute('height', 'auto');
                } else if (height > 0) {
                    croppedImageTag.setAttribute('width', 'auto');
                    croppedImageTag.setAttribute('height', height + 'px');
                }

                croppedImage = canvasTmp.toDataURL("image/jpeg", 0.8);
                croppedImageTag.setAttribute('src', croppedImage);
                // console.log('Size of crop_video:', croppedImage.length)

                resize_image(croppedImageTag, resizedImageTag)
            }

            const MAX_SEND_SIZE = 60;
            function resize_image(src, dst, type, quality) {
                let tmp = new Image(),
                    canvas, context, cW, cH;

                type = type || 'image/jpeg';
                quality = quality || 0.8;

                cW = src.naturalWidth;
                cH = src.naturalHeight;

                tmp.src = src.src;
                tmp.onload = function () {

                    canvas = document.createElement('canvas');

                    if (cW < src.width) cW = src.width;
                    if (cH < src.height) cH = src.height;

                    // cW /= 2;
                    // cH /= 2;
                    cW = cW < MAX_SEND_SIZE ? cW : MAX_SEND_SIZE;
                    cH = cH < MAX_SEND_SIZE ? cH : MAX_SEND_SIZE;

                    canvas.width = cW;
                    canvas.height = cH;
                    context = canvas.getContext('2d');
                    context.drawImage(tmp, 0, 0, cW, cH);

                    resizedImage =  canvas.toDataURL(type, quality);
                    dst.src = resizedImage;
                    // console.log('Size of resize_image:', resizedImage.length)

                    if (cW <= src.width || cH <= src.height)
                        return;

                    tmp.src = dst.src;
                }

            }

        </script>
    </div>
</body>

</html>